<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>gists • Lütfi</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica Neue, Arial, sans-serif;
    max-width: 900px;
    margin: 40px auto;
    padding: 0 16px;
    color: #1f2937;
    background: #fff;
  }
  header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .tag {
    font-size: .75rem;
    background: #eef;
    border: 1px solid #dde;
    border-radius: 999px;
    padding: .15rem .5rem;
    margin-right: .25rem;
  }
  .list a { color: inherit; text-decoration: none; }
  .list-item { padding: 12px 0; border-bottom: 1px solid #eee; }
  .muted { color: #6b7280; font-size: .9rem; }
  pre code {
    display: block;
    overflow-x: auto;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
  }
</style>
</head>
<body>
<header>
  <h1>gists</h1>
  <nav><a href="#">All</a></nav>
</header>

<main id="app" role="main" aria-live="polite"></main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
const app = document.getElementById('app');
let cache = { index: null, files: new Map() };

async function loadIndex() {
  if (cache.index) return cache.index;
  const res = await fetch('./gists/index.json', {cache:'no-cache'});
  if (!res.ok) throw new Error('index.json not found');
  cache.index = await res.json();
  return cache.index;
}

function renderList(items) {
  app.innerHTML = `
    <div class="list">
      ${items.map(x => `
        <div class="list-item">
          <a href="#/${x.slug}"><h3>${x.title}</h3></a>
          <div class="muted">${x.date} ${x.tags?.map(t=>`<span class="tag">${t}</span>`).join('') || ''}</div>
          ${x.summary ? `<p>${x.summary}</p>` : ''}
        </div>
      `).join('')}
    </div>`;
}

async function renderGist(slug) {
  try {
    const idx = await loadIndex();
    const item = idx.find(x => x.slug === slug);
    if (!item) throw new Error('not found');

    if (!cache.files.has(slug)) {
      const res = await fetch(`./gists/${item.file}`, {cache:'no-cache'});
      if (!res.ok) throw new Error('file not found');
      cache.files.set(slug, await res.text());
    }
    const code = cache.files.get(slug);
    app.innerHTML = `
      <article>
        <h2>${item.title}</h2>
        <div class="muted">${item.date}</div>
        <pre><code class="language-${item.lang}">${escapeHtml(code)}</code></pre>
      </article>
    `;
    document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
  } catch (e) {
    app.innerHTML = `<p class="muted">Not found.</p>`;
  }
}

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[s]));
}

async function router() {
  const hash = location.hash.replace(/^#\/?/, '');
  if (!hash) {
    const idx = await loadIndex();
    renderList(idx);
  } else {
    await renderGist(hash);
  }
}
window.addEventListener('hashchange', router);
router();
</script>
</body>
</html>