<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="light dark" />
<title>gists • Lütfi</title>

<!-- Highlight.js themes (auto via media) -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
  media="(prefers-color-scheme: light)">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
  media="(prefers-color-scheme: dark)">

<style>
  :root {
    color-scheme: light dark;
    --bg: #ffffff;
    --fg: #1f2937;
    --muted: #6b7280;
    --card: #fafafa;
    --border: #e5e7eb;
    --tag-bg: #eef;
    --tag-bd: #dde;
    --accent: #3b82f6;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0b0e12;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --card: #11161c;
      --border: #243041;
      --tag-bg: #1b2a4a;
      --tag-bd: #2b3a5a;
      --accent: #60a5fa;
    }
  }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica Neue, Arial, sans-serif;
    max-width: 900px;
    margin: 40px auto;
    padding: 0 16px;
    color: var(--fg);
    background: var(--bg);
  }
  header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .filter-bar {
    display:flex;
    justify-content:flex-end;
    margin-bottom:.75rem;
  }
  .filter-bar label {
    font-size:.9rem;
    cursor:pointer;
    user-select:none;
    color:var(--muted);
  }
  .filter-bar input {
    margin-right:.35rem;
  }
  .tag {
    font-size: .75rem;
    background: var(--tag-bg);
    border: 1px solid var(--tag-bd);
    border-radius: 999px;
    padding: .15rem .5rem;
    margin-right: .25rem;
  }
  .list a.title { color: inherit; text-decoration: none; }
  .list-item { padding: 12px 0; border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; gap:8px; }
  .muted { color: var(--muted); font-size: .9rem; }
  pre code {
    display: block;
    overflow-x: auto;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
  }
  .star-btn {
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    border-radius: 8px;
    padding: 4px 8px;
    cursor: pointer;
    align-self: start;
  }
  .star-btn.fav { color: var(--accent); border-color: var(--accent); }
  .star { font-size: 1rem; margin-right:.35rem; }
  article h2 { margin-bottom: .25rem; }
  .actions { margin: .5rem 0 1rem; }
</style>
</head>
<body>
<header>
  <h1>gists</h1>
</header>

<main id="app" role="main" aria-live="polite"></main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
const app = document.getElementById('app');
const LS_KEY = 'gists:favs';

let cache = { index: null, files: new Map() };

function getFavs() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    return new Set(raw ? JSON.parse(raw) : []);
  } catch { return new Set(); }
}
function setFavs(set) {
  localStorage.setItem(LS_KEY, JSON.stringify([...set]));
}
function toggleFav(slug) {
  const favs = getFavs();
  favs.has(slug) ? favs.delete(slug) : favs.add(slug);
  setFavs(favs);
  document.querySelectorAll(`[data-star="${slug}"]`).forEach(btn => {
    btn.classList.toggle('fav', favs.has(slug));
    btn.setAttribute('aria-pressed', favs.has(slug));
    btn.querySelector('.star').textContent = favs.has(slug) ? '★' : '☆';
  });
  // refresh toggle UI if list is rendered
  if (document.querySelector('#onlyFavsToggle')) {
    renderList(cache.index);
  }
}

async function loadIndex() {
  if (cache.index) return cache.index;
  const res = await fetch('./gists/index.json', {cache:'no-cache'});
  if (!res.ok) throw new Error('index.json not found');
  cache.index = await res.json();
  return cache.index;
}

function renderList(items) {
  const favs = getFavs();
  const showOnlyFavs = document.querySelector('#onlyFavsToggle')?.checked;
  const filtered = showOnlyFavs ? items.filter(x => favs.has(x.slug)) : items;

  const toggleHtml = favs.size > 0 ? `
    <div class="filter-bar">
      <label><input type="checkbox" id="onlyFavsToggle" ${showOnlyFavs ? 'checked' : ''}/>Only favorites</label>
    </div>` : '';

  app.innerHTML = `
    ${toggleHtml}
    <div class="list">
      ${filtered.map(x => `
        <div class="list-item">
          <div>
            <a class="title" href="#/${x.slug}"><h3>${x.title}</h3></a>
            <div class="muted">${x.date} ${x.tags?.map(t=>`<span class="tag">${t}</span>`).join('') || ''}</div>
            ${x.summary ? `<p>${x.summary}</p>` : ''}
          </div>
          <button class="star-btn ${favs.has(x.slug) ? 'fav' : ''}" data-star="${x.slug}" aria-pressed="${favs.has(x.slug)}">
            <span class="star">${favs.has(x.slug) ? '★' : '☆'}</span>Fav
          </button>
        </div>
      `).join('')}
    </div>`;

  // Hooks
  app.querySelectorAll('.star-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault(); e.stopPropagation();
      toggleFav(btn.dataset.star);
    });
  });
  const toggle = document.querySelector('#onlyFavsToggle');
  if (toggle) toggle.addEventListener('change', () => renderList(items));
}

async function renderGist(slug) {
  try {
    const idx = await loadIndex();
    const item = idx.find(x => x.slug === slug);
    if (!item) throw new Error('not found');

    if (!cache.files.has(slug)) {
      const res = await fetch(`./gists/${item.file}`, {cache:'no-cache'});
      if (!res.ok) throw new Error('file not found');
      cache.files.set(slug, await res.text());
    }
    const code = cache.files.get(slug);
    const favs = getFavs();
    const isFav = favs.has(slug);

    app.innerHTML = `
      <article>
        <h2>${item.title}</h2>
        <div class="muted">${item.date}</div>
        <div class="actions">
          <button class="star-btn ${isFav ? 'fav' : ''}" data-star="${slug}" aria-pressed="${isFav}">
            <span class="star">${isFav ? '★' : '☆'}</span>${isFav ? 'Favorited' : 'Add to favorites'}
          </button>
          <a href="#" style="margin-left:.5rem">Back</a>
        </div>
        <pre><code class="language-${item.lang}">${escapeHtml(code)}</code></pre>
      </article>
    `;
    document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
    app.querySelector('.star-btn[data-star]').addEventListener('click', e => {
      e.preventDefault(); toggleFav(slug);
    });
  } catch (e) {
    app.innerHTML = `<p class="muted">Not found.</p>`;
  }
}

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[s]));
}

async function router() {
  const slug = location.hash.replace(/^#\/?/, '');
  if (!slug) {
    const idx = await loadIndex();
    renderList(idx);
  } else {
    await renderGist(slug);
  }
}
window.addEventListener('hashchange', router);
router();
</script>
</body>
</html>